{% extends 'base.html' %}
{% load static %}

{% block title %}Comment Thread - CommuMap{% endblock %}

{% block extra_css %}
<style>
    .thread-header {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    }
    
    .comment-bubble {
        position: relative;
        padding: 1rem;
        border-radius: 1rem;
        margin-bottom: 1rem;
    }
    
    .comment-bubble.user {
        background: #f3f4f6;
        margin-right: 2rem;
    }
    
    .comment-bubble.moderator {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        margin-left: 2rem;
    }
    
    .comment-bubble.user::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 1rem;
        width: 0;
        height: 0;
        border: 10px solid transparent;
        border-top-color: #f3f4f6;
        border-bottom: 0;
        margin-left: -10px;
        margin-bottom: -10px;
    }
    
    .comment-bubble.moderator::after {
        content: '';
        position: absolute;
        bottom: 0;
        right: 1rem;
        width: 0;
        height: 0;
        border: 10px solid transparent;
        border-top-color: #d97706;
        border-bottom: 0;
        margin-right: -10px;
        margin-bottom: -10px;
    }
    
    .service-context {
        border-left: 4px solid #8b5cf6;
        background: rgba(139, 92, 246, 0.1);
    }

    .role-badge { font-size: 0.75rem; padding: 0.3rem 0.8rem; border-radius: 30px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; border: 2px solid transparent !important; display: inline-flex; align-items: center; gap: 0.5rem; min-width: 90px; text-align: center; position: relative; overflow: hidden; color: #fff !important; }
    .role-user { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 50%, #1e40af 100%) !important; }
    .role-admin { background: linear-gradient(135deg, #ef4444 0%, #dc2626 50%, #b91c1c 100%) !important; }
    .role-community_moderator { background: linear-gradient(135deg, #f59e0b 0%, #d97706 50%, #b45309 100%) !important; }
    .role-service_manager { background: linear-gradient(135deg, #10b981 0%, #059669 50%, #047857 100%) !important; }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-base-100">
    <!-- Header -->
    <div class="thread-header text-white p-6 mb-6">
        <div class="container mx-auto">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold">Comment Thread</h1>
                    <p class="text-lg opacity-90">View and moderate comment discussion</p>
                </div>
                <div class="flex gap-4">
                    <a href="{% url 'moderators:comments_pending' %}" class="btn btn-outline btn-base-100 text-base-100 border-base-100">
                        Back to Queue
                    </a>
                    <a href="{% url 'moderators:dashboard' %}" class="btn btn-outline btn-base-100 text-base-100 border-base-100">
                        Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-6">
        <!-- Service Context -->
        <div class="service-context card bg-base-100 shadow-lg mb-8 p-6">
            <div class="flex items-center gap-4 mb-4">
                <div class="text-4xl">üè¢</div>
                <div>
                    <h2 class="text-2xl font-bold">{{ comment.service.name }}</h2>
                    <p class="text-gray-600">{{ comment.service.category.name }}</p>
                    <div class="flex items-center gap-2 mt-2">
                        <div class="badge badge-primary">{{ comment.service.get_status_display }}</div>
                        {% if comment.service.is_verified %}
                            <div class="badge badge-success">Verified</div>
                        {% endif %}
                        {% if comment.service.is_emergency_service %}
                            <div class="badge badge-error">Emergency</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <p class="text-gray-700">{{ comment.service.description|truncatewords:30 }}</p>
            <div class="mt-4">
                <a href="#" class="btn btn-info btn-sm">View Full Service</a>
            </div>
        </div>

        <!-- Comment Thread -->
        <div class="card bg-base-100 shadow-lg mb-8">
            <div class="card-header bg-purple-600 text-white p-4">
                <h3 class="text-xl font-semibold">Comment Discussion</h3>
            </div>
            <div class="card-body p-6">
                <!-- Main Comment -->
                <div class="comment-bubble user">
                    <div class="flex items-start gap-3 mb-3">
                        <div class="avatar">
                            <div class="w-10 h-10 rounded-full bg-primary text-primary-content flex items-center justify-center text-sm">
                                {{ comment.user.get_display_name.0 }}
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold">{{ comment.user.get_display_name }}</h4>
                            <span class="badge badge-xs role-badge role-{{ comment.user.role }}">
                                {% if comment.user.role == 'admin' %}<i class="fas fa-crown"></i> ADMIN
                                {% elif comment.user.role == 'community_moderator' %}<i class="fas fa-shield-alt"></i> COMMUNITY MODERATOR
                                {% elif comment.user.role == 'service_manager' %}<i class="fas fa-cogs"></i> SERVICE MANAGER
                                {% else %}<i class="fas fa-user"></i> USER
                                {% endif %}
                            </span>
                            <p class="text-sm text-gray-500">{{ comment.created_at|date:"M d, Y H:i" }}</p>
                        </div>
                        <div class="ml-auto">
                            {% if comment.is_approved %}
                                <div class="badge badge-success">Approved</div>
                            {% else %}
                                <div class="badge badge-warning">Pending</div>
                            {% endif %}
                        </div>
                    </div>
                    <p class="text-gray-700">{{ comment.content }}</p>
                </div>

                <!-- Related Comments (if any) -->
                {% if related_comments|length > 1 %}
                <div class="divider">Related Comments</div>
                {% for related_comment in related_comments %}
                    {% if related_comment.pk != comment.pk %}
                    <div class="comment-bubble user">
                        <div class="flex items-start gap-3 mb-3">
                            <div class="avatar">
                                <div class="w-8 h-8 rounded-full bg-secondary text-secondary-content flex items-center justify-center text-xs">
                                    {{ related_comment.user.get_display_name.0 }}
                                </div>
                            </div>
                            <div>
                                <h5 class="font-medium">{{ related_comment.user.get_display_name }}</h5>
                                <span class="badge badge-xs role-badge role-{{ related_comment.user.role }}">
                                    {% if related_comment.user.role == 'admin' %}<i class="fas fa-crown"></i> ADMIN
                                    {% elif related_comment.user.role == 'community_moderator' %}<i class="fas fa-shield-alt"></i> COMMUNITY MODERATOR
                                    {% elif related_comment.user.role == 'service_manager' %}<i class="fas fa-cogs"></i> SERVICE MANAGER
                                    {% else %}<i class="fas fa-user"></i> USER
                                    {% endif %}
                                </span>
                                <p class="text-xs text-gray-500">{{ related_comment.created_at|date:"M d, Y H:i" }}</p>
                            </div>
                            <div class="ml-auto">
                                {% if related_comment.is_approved %}
                                    <div class="badge badge-success badge-sm">Approved</div>
                                {% else %}
                                    <div class="badge badge-warning badge-sm">Pending</div>
                                {% endif %}
                            </div>
                        </div>
                        <p class="text-gray-700 text-sm">{{ related_comment.content|truncatewords:20 }}</p>
                    </div>
                    {% endif %}
                {% endfor %}
                {% endif %}

                <!-- Moderator Reply Section -->
                <div class="divider">Moderator Response</div>
                
                <!-- Reply Form -->
                <div class="mb-6">
                    <form onsubmit="submitReply(event)" class="space-y-4">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-semibold">Your Response</span>
                            </label>
                            <textarea id="replyContent" class="textarea textarea-bordered w-full h-32" 
                                      placeholder="Write your moderator response to address the user's comment..."></textarea>
                        </div>
                        
                        <div class="flex gap-4">
                            <button type="submit" class="btn btn-warning gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                                </svg>
                                Send Reply
                            </button>
                            <button type="button" onclick="previewReply()" class="btn btn-outline">
                                Preview
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Example Moderator Reply (for demonstration) -->
                <div class="comment-bubble moderator">
                    <div class="flex items-start gap-3 mb-3">
                        <div class="avatar">
                            <div class="w-10 h-10 rounded-full bg-white text-warning flex items-center justify-center text-sm">
                                üõ°Ô∏è
                            </div>
                        </div>
                        <div>
                            <h4 class="font-semibold">{{ user.get_display_name }}</h4>
                            <p class="text-sm opacity-90">Community Moderator ‚Ä¢ Just now</p>
                        </div>
                        <div class="ml-auto">
                            <div class="badge badge-accent">Moderator</div>
                        </div>
                    </div>
                    <p class="opacity-90" id="replyPreview">Your reply will appear here...</p>
                </div>
            </div>
        </div>

        <!-- Action Panel -->
        <div class="card bg-base-100 shadow-lg">
            <div class="card-header bg-gray-700 text-white p-4">
                <h3 class="text-xl font-semibold">Moderation Actions</h3>
            </div>
            <div class="card-body p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    {% if not comment.is_approved %}
                    <button onclick="approveComment()" class="btn btn-success btn-lg gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                        Approve Comment
                    </button>
                    {% endif %}
                    
                    <button onclick="flagComment()" class="btn btn-warning btn-lg gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 2H21l-3 6 3 6h-8.5l-1-2H5a2 2 0 00-2 2zm9-13.5V9"/>
                        </svg>
                        Flag for Review
                    </button>
                    
                    <button onclick="deleteComment()" class="btn btn-error btn-lg gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                        Delete Comment
                    </button>
                </div>
                
                <!-- Quick Actions -->
                <div class="divider">Quick Actions</div>
                <div class="flex flex-wrap gap-2">
                    <button onclick="insertTemplate('thank_you')" class="btn btn-sm btn-outline">
                        Thank You Template
                    </button>
                    <button onclick="insertTemplate('clarification')" class="btn btn-sm btn-outline">
                        Request Clarification
                    </button>
                    <button onclick="insertTemplate('policy')" class="btn btn-sm btn-outline">
                        Policy Reminder
                    </button>
                    <button onclick="insertTemplate('resolved')" class="btn btn-sm btn-outline">
                        Mark as Resolved
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function submitReply(event) {
    event.preventDefault();
    
    const content = document.getElementById('replyContent').value.trim();
    if (!content) {
        alert('Please enter a reply message.');
        return;
    }
    
    // TODO: Implement AJAX submission
    console.log('Submitting moderator reply:', content);
    
    // Show success message
    alert('Reply sent successfully!');
    
    // Clear form
    document.getElementById('replyContent').value = '';
    document.getElementById('replyPreview').textContent = 'Your reply will appear here...';
}

function previewReply() {
    const content = document.getElementById('replyContent').value.trim();
    const preview = document.getElementById('replyPreview');
    
    if (content) {
        preview.textContent = content;
    } else {
        preview.textContent = 'Your reply will appear here...';
    }
}

function approveComment() {
    if (confirm('Are you sure you want to approve this comment?')) {
        // TODO: Implement AJAX call
        console.log('Approving comment:', '{{ comment.pk }}');
        
        // Update UI
        const badge = document.querySelector('.badge-warning');
        if (badge) {
            badge.className = 'badge badge-success';
            badge.textContent = 'Approved';
        }
        
        alert('Comment approved successfully!');
    }
}

function flagComment() {
    const reason = prompt('Please provide a reason for flagging this comment:');
    if (reason && reason.trim()) {
        // TODO: Implement AJAX call
        console.log('Flagging comment:', '{{ comment.pk }}', 'Reason:', reason);
        alert('Comment flagged for review.');
    }
}

function deleteComment() {
    if (confirm('Are you sure you want to delete this comment? This action cannot be undone.')) {
        // TODO: Implement AJAX call
        console.log('Deleting comment:', '{{ comment.pk }}');
        alert('Comment deleted successfully!');
        window.location.href = '{% url "moderators:comments_pending" %}';
    }
}

function insertTemplate(type) {
    const textarea = document.getElementById('replyContent');
    let template = '';
    
    switch(type) {
        case 'thank_you':
            template = "Thank you for your feedback! We appreciate you taking the time to share your experience with our community.";
            break;
        case 'clarification':
            template = "Could you please provide more specific details about your experience? This will help us better understand your concerns.";
            break;
        case 'policy':
            template = "Please remember to keep comments respectful and constructive as outlined in our community guidelines.";
            break;
        case 'resolved':
            template = "Thank you for bringing this to our attention. This issue has been resolved and appropriate action has been taken.";
            break;
    }
    
    if (textarea.value.trim()) {
        textarea.value += '\n\n' + template;
    } else {
        textarea.value = template;
    }
    
    previewReply();
}

// Auto-preview as user types
document.addEventListener('DOMContentLoaded', function() {
    const textarea = document.getElementById('replyContent');
    textarea.addEventListener('input', previewReply);
});
</script>
{% endblock %} 