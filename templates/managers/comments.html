{% extends 'base.html' %}
{% load static %}

{% block title %}{{ service.name }} - Comments - CommuMap{% endblock %}

{% block extra_css %}
<style>
    .comments-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }
    .comment-thread {
        background: white;
        border-radius: 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 1.5rem;
        overflow: hidden;
    }
    .comment-item {
        padding: 1.5rem;
        border-bottom: 1px solid #f3f4f6;
    }
    .comment-item:last-child {
        border-bottom: none;
    }
    .comment-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 1rem;
    }
    .comment-content {
        color: #374151;
        line-height: 1.6;
        margin-bottom: 1rem;
    }
    .comment-actions {
        display: flex;
        gap: 1rem;
        align-items: center;
    }
    .comment-replies {
        background: #f9fafb;
        border-left: 3px solid #d1d5db;
        margin-top: 1rem;
        padding-left: 1rem;
    }
    .reply-item {
        padding: 1rem;
        border-bottom: 1px solid #e5e7eb;
        background: white;
        margin: 0.5rem 0;
        border-radius: 0.5rem;
    }
    .reply-item:last-child {
        border-bottom: none;
    }
    .manager-reply {
        background: #eff6ff;
        border-left: 3px solid #3b82f6;
    }
    .filter-section {
        background: white;
        padding: 1.5rem;
        border-radius: 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }
    .filter-row {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr auto;
        gap: 1rem;
        align-items: end;
    }
    .stats-section {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        text-align: center;
    }
    .collapsed .comment-replies {
        display: none;
    }
    .expand-btn {
        cursor: pointer;
        user-select: none;
        color: #3b82f6;
        font-weight: 500;
    }
    .expand-btn:hover {
        text-decoration: underline;
    }
    @media (max-width: 768px) {
        .comments-header {
            flex-direction: column;
            gap: 1rem;
            align-items: stretch;
        }
        .filter-row {
            grid-template-columns: 1fr;
        }
        .comment-header {
            flex-direction: column;
            gap: 1rem;
        }
        .comment-actions {
            flex-wrap: wrap;
            justify-content: center;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 main-content-spacing">
    <!-- Header -->
    <div class="comments-header">
        <div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">üí≠ Service Comments</h1>
            <p class="text-gray-600">{{ service.name }}</p>
            <p class="text-sm text-gray-500">{{ service.address }}</p>
        </div>
        <div class="flex gap-2">
            <a href="{% url 'manager:service_feedback' service.id %}" class="btn btn-outline">
                üí¨ View Reviews
            </a>
        </div>
    </div>

    <!-- Comments Statistics -->
    <div class="stats-section">
        <div class="stat-card">
            <div class="text-2xl font-bold text-blue-600 mb-2">24</div>
            <div class="text-gray-600">Total Comments</div>
        </div>
        <div class="stat-card">
            <div class="text-2xl font-bold text-green-600 mb-2">8</div>
            <div class="text-gray-600">Comment Threads</div>
        </div>
        <div class="stat-card">
            <div class="text-2xl font-bold text-purple-600 mb-2">3</div>
            <div class="text-gray-600">Unread</div>
        </div>
        <div class="stat-card">
            <div class="text-2xl font-bold text-yellow-600 mb-2">18</div>
            <div class="text-gray-600">Your Replies</div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filter-section">
        <form method="get" class="filter-row">
            <div class="form-control">
                <label class="label">
                    <span class="label-text">Search Comments</span>
                </label>
                <input type="text" name="q" placeholder="Search by content, username..." 
                       value="{{ request.GET.q|default:'' }}" 
                       class="input input-bordered">
            </div>
            
            <div class="form-control">
                <label class="label">
                    <span class="label-text">Type</span>
                </label>
                <select name="type" class="select select-bordered">
                    <option value="">All Comments</option>
                    <option value="question" {% if request.GET.type == 'question' %}selected{% endif %}>Questions</option>
                    <option value="suggestion" {% if request.GET.type == 'suggestion' %}selected{% endif %}>Suggestions</option>
                    <option value="complaint" {% if request.GET.type == 'complaint' %}selected{% endif %}>Complaints</option>
                    <option value="compliment" {% if request.GET.type == 'compliment' %}selected{% endif %}>Compliments</option>
                </select>
            </div>
            
            <div class="form-control">
                <label class="label">
                    <span class="label-text">Status</span>
                </label>
                <select name="status" class="select select-bordered">
                    <option value="">All</option>
                    <option value="unread" {% if request.GET.status == 'unread' %}selected{% endif %}>Unread</option>
                    <option value="replied" {% if request.GET.status == 'replied' %}selected{% endif %}>Replied</option>
                    <option value="resolved" {% if request.GET.status == 'resolved' %}selected{% endif %}>Resolved</option>
                </select>
            </div>
            
            <div class="form-control">
                <button type="submit" class="btn btn-primary">
                    üîç Filter
                </button>
            </div>
        </form>
    </div>

    <!-- Quick Filters -->
    <div class="flex flex-wrap gap-2 mb-6">
        <a href="?" class="btn btn-outline btn-sm {% if not request.GET %}btn-active{% endif %}">
            All Comments
        </a>
        <a href="?status=unread" class="btn btn-outline btn-sm {% if request.GET.status == 'unread' %}btn-active{% endif %}">
            üí≠ Unread (3)
        </a>
        <a href="?type=question" class="btn btn-outline btn-sm {% if request.GET.type == 'question' %}btn-active{% endif %}">
            ‚ùì Questions
        </a>
        <a href="?type=complaint" class="btn btn-outline btn-sm {% if request.GET.type == 'complaint' %}btn-active{% endif %}">
            ‚ö†Ô∏è Complaints
        </a>
    </div>

    <!-- Comments List -->
    <div class="space-y-4">
        {% for comment in comments %}
            <div class="comment-thread" id="thread-{{ comment.id }}">
                <!-- Main Comment -->
                <div class="comment-item">
                    <div class="comment-header">
                        <div class="flex items-center gap-3">
                            <div class="avatar placeholder">
                                <div class="bg-neutral text-neutral-content rounded-full w-12 h-12">
                                    <span class="text-lg">{{ comment.user.username|first|upper }}</span>
                                </div>
                            </div>
                            <div>
                                <div class="font-semibold text-gray-800">
                                    {{ comment.user.get_display_name|default:comment.user.username }}
                                </div>
                                <div class="text-sm text-gray-500">
                                    {{ comment.created_at|timesince }} ago
                                    {% if comment.is_edited %}‚Ä¢ Edited{% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex items-center gap-2">
                            {% if comment.comment_type %}
                                <span class="badge badge-outline badge-sm">
                                    {% if comment.comment_type == 'question' %}‚ùì Question
                                    {% elif comment.comment_type == 'suggestion' %}üí° Suggestion
                                    {% elif comment.comment_type == 'complaint' %}‚ö†Ô∏è Complaint
                                    {% elif comment.comment_type == 'compliment' %}üëç Compliment
                                    {% else %}üí≠ Comment
                                    {% endif %}
                                </span>
                            {% endif %}
                            
                            {% if not comment.is_read %}
                                <span class="badge badge-primary badge-sm">New</span>
                            {% endif %}
                            
                            {% if comment.is_resolved %}
                                <span class="badge badge-success badge-sm">Resolved</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="comment-content">
                        {{ comment.content }}
                    </div>
                    
                    <div class="comment-actions">
                        <button onclick="likeComment('{{ comment.id }}')" 
                                class="text-sm text-gray-600 hover:text-blue-600">
                            üëç {{ comment.likes_count|default:0 }}
                        </button>
                        
                        <button onclick="openReplyModal('{{ comment.id }}', '{{ comment.user.get_display_name|default:comment.user.username }}', '{{ comment.content|escapejs }}')" 
                                class="text-sm text-blue-600 hover:underline">
                            üí¨ Reply
                        </button>
                        
                        {% if not comment.is_read %}
                            <button onclick="markAsRead('{{ comment.id }}')" 
                                    class="text-sm text-green-600 hover:underline">
                                ‚úì Mark Read
                            </button>
                        {% endif %}
                        
                        {% if comment.comment_type == 'complaint' or comment.comment_type == 'question' %}
                            {% if not comment.is_resolved %}
                                <button onclick="markAsResolved('{{ comment.id }}')" 
                                        class="text-sm text-purple-600 hover:underline">
                                    ‚úÖ Mark Resolved
                                </button>
                            {% endif %}
                        {% endif %}
                        
                        <div class="dropdown dropdown-end">
                            <label tabindex="0" class="text-sm text-gray-600 hover:text-gray-800 cursor-pointer">‚ãÆ</label>
                            <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-40">
                                <li>
                                    <a onclick="shareComment('{{ comment.id }}')">
                                        üì§ Share
                                    </a>
                                </li>
                                <li>
                                    <a onclick="flagComment('{{ comment.id }}')">
                                        üö© Flag
                                    </a>
                                </li>
                                <li class="divider"></li>
                                <li>
                                    <a onclick="reportComment('{{ comment.id }}')" class="text-error">
                                        ‚ö†Ô∏è Report
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Replies Section -->
                    {% if comment.replies.exists %}
                        <div class="mt-4">
                            <div class="expand-btn" onclick="toggleReplies('{{ comment.id }}')">
                                <span id="toggle-text-{{ comment.id }}">‚ñº Show {{ comment.replies.count }} repl{{ comment.replies.count|pluralize:"y,ies" }}</span>
                            </div>
                            
                            <div class="comment-replies" id="replies-{{ comment.id }}">
                                {% for reply in comment.replies.all %}
                                    <div class="reply-item {% if reply.user == service.manager %}manager-reply{% endif %}">
                                        <div class="flex items-start gap-3 mb-2">
                                            <div class="avatar placeholder">
                                                <div class="bg-base-300 text-base-content rounded-full w-8 h-8">
                                                    <span class="text-xs">{{ reply.user.username|first|upper }}</span>
                                                </div>
                                            </div>
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2 mb-1">
                                                    <span class="font-medium text-sm">
                                                        {{ reply.user.get_display_name|default:reply.user.username }}
                                                    </span>
                                                    <span class="badge badge-xs role-badge role-{{ reply.user.role }}">
                                                        {% if reply.user.role == 'admin' %}<i class="fas fa-crown"></i> ADMIN
                                                        {% elif reply.user.role == 'community_moderator' %}<i class="fas fa-shield-alt"></i> COMMUNITY MODERATOR
                                                        {% elif reply.user.role == 'service_manager' %}<i class="fas fa-cogs"></i> SERVICE MANAGER
                                                        {% else %}<i class="fas fa-user"></i> USER
                                                        {% endif %}
                                                    </span>
                                                    <span class="text-xs text-gray-500">
                                                        {{ reply.created_at|timesince }} ago
                                                    </span>
                                                </div>
                                                <div class="text-sm text-gray-700">
                                                    {{ reply.content }}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        {% empty %}
            <!-- Empty State -->
            <div class="text-center py-16">
                <div class="text-6xl mb-4">üí≠</div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">No Comments Found</h3>
                <p class="text-gray-600 mb-6">
                    {% if request.GET %}
                        No comments match your current filters. Try adjusting your search criteria.
                    {% else %}
                        No comments have been posted for this service yet.
                    {% endif %}
                </p>
                {% if request.GET %}
                    <a href="{% url 'manager:service_comments' service.id %}" class="btn btn-outline">
                        Clear Filters
                    </a>
                {% endif %}
            </div>
        {% endfor %}
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
        <div class="flex justify-center mt-8">
            <div class="btn-group">
                {% if page_obj.has_previous %}
                    <a href="?page=1" class="btn btn-outline">First</a>
                    <a href="?page={{ page_obj.previous_page_number }}" class="btn btn-outline">Previous</a>
                {% endif %}
                
                <span class="btn btn-active">
                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                </span>
                
                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}" class="btn btn-outline">Next</a>
                    <a href="?page={{ page_obj.paginator.num_pages }}" class="btn btn-outline">Last</a>
                {% endif %}
            </div>
        </div>
    {% endif %}

    <!-- Navigation -->
    <div class="text-center mt-8">
        <div class="flex gap-4 justify-center">
            <a href="{% url 'manager:service_feedback' service.id %}" class="btn btn-outline">
                üí¨ View Reviews
            </a>
            <a href="{% url 'manager:service_analytics' service.id %}" class="btn btn-outline">
                üìà View Analytics
            </a>
            <a href="{% url 'manager:services' %}" class="btn btn-ghost">
                ‚Üê Back to My Services
            </a>
        </div>
    </div>
</div>

<!-- Reply Modal -->
<dialog id="reply-modal" class="modal">
    <div class="modal-box max-w-2xl">
        <h3 class="font-bold text-lg mb-4">üí¨ Reply to Comment</h3>
        
        <div class="bg-gray-50 p-4 rounded-lg mb-4">
            <div class="flex items-center gap-2 mb-2">
                <strong id="commenter-name"></strong>
                <span class="text-sm text-gray-500">wrote:</span>
            </div>
            <div id="original-comment" class="text-gray-700"></div>
        </div>
        
        <form id="reply-form">
            <div class="form-control mb-4">
                <label class="label">
                    <span class="label-text">Your Reply</span>
                </label>
                <textarea id="reply-text" 
                          class="textarea textarea-bordered h-32" 
                          placeholder="Thank you for your comment..."></textarea>
            </div>
            
            <div class="form-control mb-6">
                <label class="cursor-pointer label">
                    <span class="label-text">Send notification to commenter</span>
                    <input type="checkbox" id="notify-user" class="checkbox checkbox-primary" checked>
                </label>
            </div>
            
            <div class="modal-action">
                <button type="button" class="btn" onclick="closeReplyModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Send Reply</button>
            </div>
        </form>
    </div>
</dialog>
{% endblock %}

{% block extra_js %}
<script>
let currentCommentId = null;

function toggleReplies(commentId) {
    const repliesSection = document.getElementById(`replies-${commentId}`);
    const toggleText = document.getElementById(`toggle-text-${commentId}`);
    const thread = document.getElementById(`thread-${commentId}`);
    
    if (thread.classList.contains('collapsed')) {
        thread.classList.remove('collapsed');
        toggleText.textContent = toggleText.textContent.replace('‚ñ∂ Show', '‚ñº Hide');
    } else {
        thread.classList.add('collapsed');
        toggleText.textContent = toggleText.textContent.replace('‚ñº Hide', '‚ñ∂ Show');
    }
}

function markAsRead(commentId) {
    console.log('Marking comment as read:', commentId);
    // Here you would make an AJAX call to mark the comment as read
    event.target.remove();
}

function markAsResolved(commentId) {
    console.log('Marking comment as resolved:', commentId);
    // Here you would make an AJAX call to mark the comment as resolved
    alert('Comment marked as resolved!');
    event.target.remove();
}

function likeComment(commentId) {
    console.log('Liking comment:', commentId);
    // Here you would make an AJAX call to toggle like status
    // For demo, just increment the counter
    const button = event.target;
    const currentCount = parseInt(button.textContent.split(' ')[1]) || 0;
    button.textContent = `üëç ${currentCount + 1}`;
}

function openReplyModal(commentId, commenterName, originalComment) {
    currentCommentId = commentId;
    
    document.getElementById('commenter-name').textContent = commenterName;
    document.getElementById('original-comment').textContent = originalComment;
    document.getElementById('reply-text').value = '';
    
    document.getElementById('reply-modal').showModal();
}

function closeReplyModal() {
    document.getElementById('reply-modal').close();
    currentCommentId = null;
}

function shareComment(commentId) {
    console.log('Sharing comment:', commentId);
    // Here you would implement sharing functionality
    alert('Share functionality for comment: ' + commentId);
}

function flagComment(commentId) {
    console.log('Flagging comment:', commentId);
    // Here you would make an AJAX call to flag the comment
    alert('Comment flagged: ' + commentId);
}

function reportComment(commentId) {
    if (confirm('Are you sure you want to report this comment?')) {
        console.log('Reporting comment:', commentId);
        // Here you would make an AJAX call to report the comment
        alert('Comment reported: ' + commentId);
    }
}

// Handle reply form submission
document.getElementById('reply-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const replyText = document.getElementById('reply-text').value;
    const notifyUser = document.getElementById('notify-user').checked;
    
    if (!replyText.trim()) {
        alert('Please enter a reply message.');
        return;
    }
    
    // Here you would make an AJAX call to save the reply
    console.log('Saving reply for comment:', currentCommentId, {
        reply: replyText,
        notifyUser: notifyUser
    });
    
    alert('Reply sent successfully!');
    closeReplyModal();
    
    // Refresh the page to show the new reply
    location.reload();
});

// Auto-collapse long threads on page load
document.addEventListener('DOMContentLoaded', function() {
    const threads = document.querySelectorAll('.comment-thread');
    threads.forEach(thread => {
        const replies = thread.querySelector('.comment-replies');
        if (replies && replies.children.length > 3) {
            thread.classList.add('collapsed');
            const commentId = thread.id.replace('thread-', '');
            const toggleText = document.getElementById(`toggle-text-${commentId}`);
            if (toggleText) {
                toggleText.textContent = toggleText.textContent.replace('‚ñº Hide', '‚ñ∂ Show');
            }
        }
    });
});

// Auto-refresh unread count every 30 seconds
setInterval(function() {
    console.log('Checking for new comments...');
    // Here you would make an AJAX call to check for new comments
}, 30000);
</script>
{% endblock %} 