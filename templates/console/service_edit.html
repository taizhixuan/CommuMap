{% extends "console/service_create.html" %}

{% block title %}Edit Service: {{ object.name }} - CommuMap Admin{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="service-form-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-2">Edit Service: {{ object.name }}</h1>
                <p class="mb-0">Manage all aspects of this community service</p>
            </div>
            <div>
                <a href="{% url 'console:services' %}" class="btn btn-light me-2">
                    <i class="fas fa-arrow-left"></i> Back to Services
                </a>
                <a href="{% url 'services:detail' object.id %}" class="btn btn-outline-light" target="_blank">
                    <i class="fas fa-eye"></i> View Public Page
                </a>
            </div>
        </div>
    </div>

    <!-- Service Status Info -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="alert alert-info">
                <div class="row">
                    <div class="col-md-3">
                        <strong>Current Status:</strong> 
                        <span class="badge bg-{% if object.current_status == 'open' %}success{% elif object.current_status == 'closed' %}danger{% else %}warning{% endif %}">
                            {{ object.get_current_status_display }}
                        </span>
                    </div>
                    <div class="col-md-3">
                        <strong>Verification:</strong> 
                        {% if object.is_verified %}
                            <span class="badge bg-success">Verified</span>
                            {% if object.verified_at %}
                                <small class="text-muted d-block">{{ object.verified_at|date:"M d, Y" }}</small>
                            {% endif %}
                        {% else %}
                            <span class="badge bg-warning">Pending</span>
                        {% endif %}
                    </div>
                    <div class="col-md-3">
                        <strong>Activity:</strong> 
                        <span class="badge bg-{% if object.is_active %}success{% else %}secondary{% endif %}">
                            {% if object.is_active %}Active{% else %}Inactive{% endif %}
                        </span>
                    </div>
                    <div class="col-md-3">
                        <strong>Emergency:</strong> 
                        {% if object.is_emergency_service %}
                            <span class="badge bg-danger">🚨 Emergency Service</span>
                        {% else %}
                            <span class="badge bg-secondary">Regular Service</span>
                        {% endif %}
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-6">
                        <strong>Created:</strong> {{ object.created_at|date:"M d, Y H:i" }}
                        {% if object.manager %}
                            by {{ object.manager.get_full_name }}
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <strong>Last Updated:</strong> {{ object.updated_at|date:"M d, Y H:i" }}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <form method="post" class="service-form">
        {% csrf_token %}
        
        <!-- Basic Information -->
        <div class="form-section">
            <h3 class="section-header">Basic Information</h3>
            <div class="section-content">
                <div class="form-row single">
                    <div>
                        <label class="form-label required-field">Service Name</label>
                        {{ form.name }}
                        {% if form.name.help_text %}
                            <div class="help-text">{{ form.name.help_text }}</div>
                        {% endif %}
                        {% if form.name.errors %}
                            <div class="text-danger">{{ form.name.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="form-row single">
                    <div>
                        <label class="form-label">URL Slug</label>
                        {{ form.slug }}
                        {% if form.slug.help_text %}
                            <div class="help-text">{{ form.slug.help_text }}</div>
                        {% endif %}
                        {% if form.slug.errors %}
                            <div class="text-danger">{{ form.slug.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="form-row single">
                    <div>
                        <label class="form-label required-field">Short Description</label>
                        {{ form.short_description }}
                        {% if form.short_description.help_text %}
                            <div class="help-text">{{ form.short_description.help_text }}</div>
                        {% endif %}
                        {% if form.short_description.errors %}
                            <div class="text-danger">{{ form.short_description.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="form-row single">
                    <div>
                        <label class="form-label required-field">Detailed Description</label>
                        {{ form.description }}
                        {% if form.description.help_text %}
                            <div class="help-text">{{ form.description.help_text }}</div>
                        {% endif %}
                        {% if form.description.errors %}
                            <div class="text-danger">{{ form.description.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="form-row">
                    <div>
                        <label class="form-label required-field">Category</label>
                        {{ form.category }}
                        {% if form.category.errors %}
                            <div class="text-danger">{{ form.category.errors.0 }}</div>
                        {% endif %}
                    </div>
                    <div>
                        <label class="form-label">Service Manager</label>
                        {{ form.manager }}
                        {% if form.manager.errors %}
                            <div class="text-danger">{{ form.manager.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="form-row single">
                    <div>
                        <label class="form-label">Tags</label>
                        {{ form.tags_input }}
                        {% if form.tags_input.help_text %}
                            <div class="tag-input-help">
                                <strong>💡 Tip:</strong> {{ form.tags_input.help_text }}
                            </div>
                        {% endif %}
                        {% if form.tags_input.errors %}
                            <div class="text-danger">{{ form.tags_input.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Location Information -->
        <div class="form-section">
            <h3 class="section-header">Location Information</h3>
            <div class="section-content">
                <div class="form-row single">
                    <div>
                        <label class="form-label required-field">Street Address</label>
                        {{ form.address }}
                        {% if form.address.errors %}
                            <div class="text-danger">{{ form.address.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="form-row triple">
                    <div>
                        <label class="form-label required-field">City</label>
                        {{ form.city }}
                        {% if form.city.errors %}
                            <div class="text-danger">{{ form.city.errors.0 }}</div>
                        {% endif %}
                    </div>
                    <div>
                        <label class="form-label required-field">State/Province</label>
                        {{ form.state_province }}
                        {% if form.state_province.errors %}
                            <div class="text-danger">{{ form.state_province.errors.0 }}</div>
                        {% endif %}
                    </div>
                    <div>
                        <label class="form-label">Postal Code</label>
                        {{ form.postal_code }}
                        {% if form.postal_code.errors %}
                            <div class="text-danger">{{ form.postal_code.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="form-row">
                    <div>
                        <label class="form-label">Country</label>
                        {{ form.country }}
                        {% if form.country.errors %}
                            <div class="text-danger">{{ form.country.errors.0 }}</div>
                        {% endif %}
                    </div>
                    <div></div>
                </div>
                
                <div class="form-row">
                    <div>
                        <label class="form-label">Latitude</label>
                        {{ form.latitude }}
                        {% if form.latitude.help_text %}
                            <div class="help-text">{{ form.latitude.help_text }}</div>
                        {% endif %}
                        {% if form.latitude.errors %}
                            <div class="text-danger">{{ form.latitude.errors.0 }}</div>
                        {% endif %}
                    </div>
                    <div>
                        <label class="form-label">Longitude</label>
                        {{ form.longitude }}
                        {% if form.longitude.help_text %}
                            <div class="help-text">{{ form.longitude.help_text }}</div>
                        {% endif %}
                        {% if form.longitude.errors %}
                            <div class="text-danger">{{ form.longitude.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="coordinate-helper">
                    <strong>📍 Current Location:</strong> 
                    {% if object.latitude and object.longitude %}
                        <a href="https://www.google.com/maps?q={{ object.latitude }},{{ object.longitude }}" target="_blank">
                            {{ object.latitude }}, {{ object.longitude }} (View on Google Maps)
                        </a>
                    {% else %}
                        Not set
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Contact Information -->
        <div class="form-section">
            <h3 class="section-header">Contact Information</h3>
            <div class="section-content">
                <div class="form-row">
                    <div>
                        <label class="form-label">Primary Phone</label>
                        {{ form.phone }}
                        {% if form.phone.errors %}
                            <div class="text-danger">{{ form.phone.errors.0 }}</div>
                        {% endif %}
                    </div>
                    <div>
                        <label class="form-label">Alternative Phone</label>
                        {{ form.phone_alt }}
                        {% if form.phone_alt.errors %}
                            <div class="text-danger">{{ form.phone_alt.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="form-row">
                    <div>
                        <label class="form-label">Email Address</label>
                        {{ form.email }}
                        {% if form.email.errors %}
                            <div class="text-danger">{{ form.email.errors.0 }}</div>
                        {% endif %}
                    </div>
                    <div>
                        <label class="form-label">Website URL</label>
                        {{ form.website }}
                        {% if form.website.errors %}
                            <div class="text-danger">{{ form.website.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Operating Hours -->
        <div class="form-section">
            <h3 class="section-header">Operating Hours</h3>
            <div class="section-content">
                <div class="checkbox-group">
                    <div class="form-check">
                        {{ form.is_24_7 }}
                        <label class="form-check-label" for="{{ form.is_24_7.id_for_label }}">
                            Open 24/7 (Skip individual day hours if checked)
                        </label>
                    </div>
                </div>
                
                <div class="hours-grid" id="hours-section">
                    <div>
                        <label class="form-label">Monday</label>
                        {{ form.hours_monday }}
                    </div>
                    <div>
                        <label class="form-label">Tuesday</label>
                        {{ form.hours_tuesday }}
                    </div>
                    <div>
                        <label class="form-label">Wednesday</label>
                        {{ form.hours_wednesday }}
                    </div>
                    <div>
                        <label class="form-label">Thursday</label>
                        {{ form.hours_thursday }}
                    </div>
                    <div>
                        <label class="form-label">Friday</label>
                        {{ form.hours_friday }}
                    </div>
                    <div>
                        <label class="form-label">Saturday</label>
                        {{ form.hours_saturday }}
                    </div>
                    <div>
                        <label class="form-label">Sunday</label>
                        {{ form.hours_sunday }}
                    </div>
                </div>
                
                <div class="form-row single">
                    <div>
                        <label class="form-label">Seasonal Information</label>
                        {{ form.seasonal_info }}
                        {% if form.seasonal_info.help_text %}
                            <div class="help-text">{{ form.seasonal_info.help_text }}</div>
                        {% endif %}
                        {% if form.seasonal_info.errors %}
                            <div class="text-danger">{{ form.seasonal_info.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Capacity & Service Details -->
        <div class="form-section">
            <h3 class="section-header">Capacity & Service Details</h3>
            <div class="section-content">
                <div class="form-row">
                    <div>
                        <label class="form-label">Maximum Capacity</label>
                        {{ form.max_capacity }}
                        {% if form.max_capacity.help_text %}
                            <div class="help-text">{{ form.max_capacity.help_text }}</div>
                        {% endif %}
                        {% if form.max_capacity.errors %}
                            <div class="text-danger">{{ form.max_capacity.errors.0 }}</div>
                        {% endif %}
                    </div>
                    <div>
                        <label class="form-label">Current Capacity</label>
                        {{ form.current_capacity }}
                        {% if form.current_capacity.help_text %}
                            <div class="help-text">{{ form.current_capacity.help_text }}</div>
                        {% endif %}
                        {% if form.current_capacity.errors %}
                            <div class="text-danger">{{ form.current_capacity.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
                
                {% if object.max_capacity %}
                <div class="capacity-warning">
                    <strong>📊 Capacity Status:</strong> 
                    {{ object.current_capacity }}/{{ object.max_capacity }} 
                    ({{ object.capacity_percentage|floatformat:1 }}% full)
                    {% if object.is_near_capacity %}
                        <span class="text-warning">⚠️ Near Capacity</span>
                    {% endif %}
                    {% if object.is_at_capacity %}
                        <span class="text-danger">🔴 At Capacity</span>
                    {% endif %}
                </div>
                {% endif %}
                
                <div class="form-row">
                    <div>
                        <label class="form-label">Current Status</label>
                        {{ form.current_status }}
                        {% if form.current_status.errors %}
                            <div class="text-danger">{{ form.current_status.errors.0 }}</div>
                        {% endif %}
                    </div>
                    <div></div>
                </div>
                
                <div class="checkbox-group">
                    <div class="form-check">
                        {{ form.is_emergency_service }}
                        <label class="form-check-label" for="{{ form.is_emergency_service.id_for_label }}">
                            Emergency Service
                        </label>
                    </div>
                    <div class="form-check">
                        {{ form.requires_appointment }}
                        <label class="form-check-label" for="{{ form.requires_appointment.id_for_label }}">
                            Requires Appointment
                        </label>
                    </div>
                    <div class="form-check">
                        {{ form.accepts_walk_ins }}
                        <label class="form-check-label" for="{{ form.accepts_walk_ins.id_for_label }}">
                            Accepts Walk-ins
                        </label>
                    </div>
                    <div class="form-check">
                        {{ form.is_free }}
                        <label class="form-check-label" for="{{ form.is_free.id_for_label }}">
                            Free Service
                        </label>
                    </div>
                </div>
                
                <div class="form-row single">
                    <div>
                        <label class="form-label">Cost Information</label>
                        {{ form.cost_info }}
                        {% if form.cost_info.help_text %}
                            <div class="help-text">{{ form.cost_info.help_text }}</div>
                        {% endif %}
                        {% if form.cost_info.errors %}
                            <div class="text-danger">{{ form.cost_info.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Eligibility & Requirements -->
        <div class="form-section">
            <h3 class="section-header">Eligibility & Requirements</h3>
            <div class="section-content">
                <div class="form-row single">
                    <div>
                        <label class="form-label">Eligibility Criteria</label>
                        {{ form.eligibility_criteria }}
                        {% if form.eligibility_criteria.help_text %}
                            <div class="help-text">{{ form.eligibility_criteria.help_text }}</div>
                        {% endif %}
                        {% if form.eligibility_criteria.errors %}
                            <div class="text-danger">{{ form.eligibility_criteria.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="form-row single">
                    <div>
                        <label class="form-label">Required Documents</label>
                        {{ form.required_documents }}
                        {% if form.required_documents.help_text %}
                            <div class="help-text">{{ form.required_documents.help_text }}</div>
                        {% endif %}
                        {% if form.required_documents.errors %}
                            <div class="text-danger">{{ form.required_documents.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <div class="form-row single">
                    <div>
                        <label class="form-label">Age Restrictions</label>
                        {{ form.age_restrictions }}
                        {% if form.age_restrictions.help_text %}
                            <div class="help-text">{{ form.age_restrictions.help_text }}</div>
                        {% endif %}
                        {% if form.age_restrictions.errors %}
                            <div class="text-danger">{{ form.age_restrictions.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Settings -->
        <div class="form-section">
            <h3 class="section-header">Admin Settings</h3>
            <div class="section-content">
                <div class="checkbox-group">
                    <div class="form-check">
                        {{ form.is_verified }}
                        <label class="form-check-label" for="{{ form.is_verified.id_for_label }}">
                            Verified Service
                        </label>
                        {% if form.is_verified.help_text %}
                            <div class="help-text">{{ form.is_verified.help_text }}</div>
                        {% endif %}
                    </div>
                    <div class="form-check">
                        {{ form.is_active }}
                        <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                            Active & Visible to Public
                        </label>
                        {% if form.is_active.help_text %}
                            <div class="help-text">{{ form.is_active.help_text }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="form-actions">
            <button type="submit" class="btn btn-success btn-lg me-3">
                <i class="fas fa-save"></i> Update Service
            </button>
            <a href="{% url 'console:services' %}" class="btn btn-outline-secondary btn-lg me-3">
                <i class="fas fa-times"></i> Cancel
            </a>
            <a href="{% url 'console:emergency_toggle' object.id %}" class="btn btn-warning btn-lg me-3">
                <i class="fas fa-bolt"></i> Toggle Emergency
            </a>
            <a href="{% url 'console:service_delete' object.id %}" class="btn btn-danger btn-lg"
               onclick="return confirm('Are you sure you want to delete this service?')">
                <i class="fas fa-trash"></i> Delete Service
            </a>
        </div>
    </form>
</div>

<script>
// Toggle hours section based on 24/7 checkbox
document.getElementById('{{ form.is_24_7.id_for_label }}').addEventListener('change', function() {
    const hoursSection = document.getElementById('hours-section');
    hoursSection.style.opacity = this.checked ? '0.5' : '1';
    hoursSection.style.pointerEvents = this.checked ? 'none' : 'auto';
    
    if (this.checked) {
        // Clear individual day hours when 24/7 is selected
        hoursSection.querySelectorAll('input').forEach(input => {
            if (!input.disabled) input.value = '';
        });
    }
});

// Capacity validation
function validateCapacity() {
    const maxCapacity = document.getElementById('{{ form.max_capacity.id_for_label }}').value;
    const currentCapacity = document.getElementById('{{ form.current_capacity.id_for_label }}').value;
    
    if (maxCapacity && currentCapacity && parseInt(currentCapacity) > parseInt(maxCapacity)) {
        alert('Current capacity cannot exceed maximum capacity.');
        return false;
    }
    return true;
}

// Add validation to form submission
document.querySelector('.service-form').addEventListener('submit', function(e) {
    if (!validateCapacity()) {
        e.preventDefault();
    }
});

// Initialize 24/7 state on page load
document.addEventListener('DOMContentLoaded', function() {
    const is247Checkbox = document.getElementById('{{ form.is_24_7.id_for_label }}');
    if (is247Checkbox.checked) {
        const hoursSection = document.getElementById('hours-section');
        hoursSection.style.opacity = '0.5';
        hoursSection.style.pointerEvents = 'none';
    }
});
</script>
{% endblock %} 